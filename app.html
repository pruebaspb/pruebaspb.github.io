<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRASLADOS ENTRE BODEGAS PARABARBEROS S.A.S.</title>
    <link rel="icon" type="image/jpeg" href="https://parabarberos.github.io/2.jpg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-12 text-center">
            <div class="inline-block p-2 bg-white rounded-full shadow-lg mx-auto mb-6 border-4 border-gray-200">
                <img src="https://parabarberos.github.io/2.jpg" alt="Logo Parabarberos" class="h-24 w-24 md:h-32 md:w-32 rounded-full">
            </div>
            <h1 class="text-4xl md:text-5xl font-extrabold text-gray-800 tracking-tight">TRASLADOS ENTRE BODEGAS</h1>
            <div id="userInfo" class="mt-8 flex justify-center items-center gap-4" style="display: none;">
                <div>
                    <span class="text-gray-600">Usuario:</span>
                    <span id="userEmailDisplay" class="font-bold text-gray-800">Cargando...</span>
                </div>
                <button id="logoutBtn" class="bg-gray-200 hover:bg-red-200 text-red-700 font-semibold py-2 px-4 border border-red-300 rounded-lg shadow-sm">
                    Cerrar Sesión
                </button>
            </div>
        </header>

        <!-- VISTA DE SOLICITANTE -->
        <div id="requesterView" class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start" style="display: none;">
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800 border-b pb-3">Nueva solicitud de traslado</h2>
                <div class="mb-4"><input type="search" id="searchInput" placeholder="Buscar producto..." class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                <div id="productList" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4 mb-6 min-h-[140px] max-h-[50vh] overflow-y-auto p-4 bg-gray-50 rounded-lg"></div>
                <h3 class="text-xl font-semibold mb-3 text-gray-800"> Productos seleccionados</h3>
                <div id="currentTransferRequest" class="space-y-3 mb-6 min-h-[140px] max-h-[40vh] overflow-y-auto p-4 bg-gray-50 rounded-lg"></div>
                <form id="transferForm" class="space-y-4 border-t pt-6">
                    <input type="hidden" id="editingRequestId">
                    <h3 class="text-xl font-semibold mb-3 text-gray-800"> Detalles de traslado</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label for="fromWarehouse" class="block text-sm font-medium text-gray-700">Bodega Origen:</label><select id="fromWarehouse" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm"></select></div>
                        <div><label for="toWarehouse" class="block text-sm font-medium text-gray-700">Bodega Destino:</label><select id="toWarehouse" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm"></select></div>
                        <div><label for="requesterName" class="block text-sm font-medium text-gray-700">Solicitante:</label><select id="requesterName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm bg-gray-100" disabled></select></div>
                        <div><label for="deliveryDate" class="block text-sm font-medium text-gray-700">Fecha de solicitud</label><input type="date" id="deliveryDate" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm"></div>
                    </div>
                    <input type="hidden" id="fromWarehouseHidden" value="Bodega Principal">
                    <div><label for="requesterNotes" class="block text-sm font-medium text-gray-700">Observaciones</label><textarea id="requesterNotes" rows="2" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm" placeholder="Ej: Necesito este pedido con urgencia..."></textarea></div>
                    <button type="submit" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg">ENVIAR SOLICITUD DE TRASLADO</button>
                </form>
            </div>
            <div class="lg:col-span-1">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-2xl font-semibold mb-4 text-gray-800 border-b pb-3">Mis solicitudes</h3>
                    <div class="space-y-2 mb-4">
                        <input type="text" id="requesterSearchId" placeholder="Buscar por ID..." class="w-full px-3 py-2 border rounded-lg">
                        <div class="grid grid-cols-2 gap-2">
                            <input type="date" id="requesterDateFrom" class="w-full px-3 py-2 border rounded-lg text-sm" title="Fecha Desde">
                            <input type="date" id="requesterDateTo" class="w-full px-3 py-2 border rounded-lg text-sm" title="Fecha Hasta">
                        </div>
                    </div>
                    <div class="max-h-[80vh] overflow-y-auto">
                        <h4 class="text-xl font-bold text-yellow-600 mb-2">Por Recibir</h4>
                        <div id="myShippedRequests" class="grid gap-4 mb-6 border-b pb-6"></div>
                        <h4 class="text-lg font-semibold text-black mb-2">Activas</h4>
                        <div id="myPendingRequests" class="grid gap-4 mb-6"></div>
                        <h4 class="text-lg font-semibold text-black mb-2">Historial</h4>
                        <h5 class="text-md font-semibold text-yellow-600 mb-2 mt-4">Con Novedad</h5>
                        <div id="myNoveltyRequests" class="grid gap-4 mb-6"></div>
                        <h5 class="text-md font-semibold text-green-600 mb-2">Completadas</h5>
                        <div id="myCompletedRequests" class="grid gap-4 mb-6"></div>
                        <h5 class="text-md font-semibold text-red-700 mb-2">Canceladas</h5>
                        <div id="myCancelledRequests" class="grid gap-4"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VISTA DE ADMINISTRADOR -->
        <div id="adminView" class="space-y-8" style="display: none;">
            <div id="productManagementCard" class="bg-white p-6 rounded-xl shadow-lg" style="display: none;">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800 border-b pb-3">Gestión de Productos</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                    <div>
                        <p class="text-sm text-gray-600 mb-2">Sube un archivo <strong>JSON</strong> para actualizar la lista de productos.</p>
                        <pre class="bg-gray-100 p-3 rounded-lg text-xs text-gray-700 overflow-x-auto">[{"...":"..."}]</pre>
                    </div>
                    <div class="text-center">
                        <label for="productFile" class="cursor-pointer w-full inline-block bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg">Seleccionar Archivo JSON</label>
                        <input type="file" id="productFile" class="hidden" accept=".json">
                        <span id="fileNameDisplay" class="block text-sm text-gray-500 mt-2 truncate">Ningún archivo seleccionado.</span>
                        <button id="uploadProductsBtn" class="mt-4 w-full bg-gray-800 hover:bg-black text-white font-bold py-3 px-4 rounded-lg shadow-lg">Actualizar Base de Datos</button>
                        <p id="uploadStatus" class="mt-3 text-sm font-medium"></p>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800 border-b pb-3">Traslados Activos</h2>
                    <div class="space-y-2 mb-4">
                        <input type="text" id="adminActiveSearchId" placeholder="Buscar por ID o Solicitante..." class="w-full px-3 py-2 border rounded-lg">
                        <div class="grid grid-cols-2 gap-2"><input type="date" id="adminActiveDateFrom" class="w-full px-3 py-2 border rounded-lg text-sm" title="Fecha Desde"><input type="date" id="adminActiveDateTo" class="w-full px-3 py-2 border rounded-lg text-sm" title="Fecha Hasta"></div>
                    </div>
                    <div class="max-h-[80vh] overflow-y-auto">
                        <h3 class="text-lg font-semibold text-black mb-2">Pendientes de Revisión</h3>
                        <div id="adminPendingRequests" class="grid gap-4 mb-6"></div>
                        <h3 class="text-lg font-semibold text-black mb-2">Pendientes por Nota de Traslado</h3>
                        <div id="adminPendingNtRequests" class="grid gap-4 mb-6"></div>
                        <h3 class="text-lg font-semibold text-black mb-2">Por Enviar</h3>
                        <div id="adminReadyToShipRequests" class="grid gap-4 mb-6"></div>
                        <h3 class="text-lg font-semibold text-black mb-2">Detalles de Envío</h3>
                        <div id="adminShippingDetailsRequests" class="grid gap-4 mb-6"></div>
                        <h3 class="text-lg font-semibold text-black mb-2">Pendientes por Recibir</h3>
                        <div id="adminShippedRequests" class="grid gap-4"></div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center border-b pb-3 mb-4">
                        <h2 class="text-2xl font-semibold text-gray-800">Historial</h2>
                        <button id="exportExcelBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md flex items-center space-x-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><span>Exportar</span></button>
                    </div>
                    <div class="space-y-2 mb-4">
                        <input type="text" id="adminHistorySearchId" placeholder="Buscar por ID o Solicitante..." class="w-full px-3 py-2 border rounded-lg">
                        <div class="grid grid-cols-2 gap-2"><input type="date" id="adminHistoryDateFrom" class="w-full px-3 py-2 border rounded-lg text-sm" title="Fecha Desde"><input type="date" id="adminHistoryDateTo" class="w-full px-3 py-2 border rounded-lg text-sm" title="Fecha Hasta"></div>
                    </div>
                    <div class="max-h-[80vh] overflow-y-auto">
                        <h3 class="text-lg font-semibold text-black mb-2">Completadas</h3>
                        <div id="adminCompletedRequests" class="grid gap-4 mb-6"></div>
                        <h3 class="text-lg font-semibold text-black mb-2">Con Novedad</h3>
                        <div id="adminNoveltyRequests" class="grid gap-4 mb-6"></div>
                        <h3 class="text-lg font-semibold text-black mb-2">Canceladas</h3>
                        <div id="adminCancelledRequests" class="grid gap-4"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- VISTA DE REVISOR -->
        <div id="reviewerView" class="space-y-8" style="display: none;">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800 border-b pb-3">Pendientes de Revisión</h2>
                <div class="space-y-2 mb-4">
                    <input type="text" id="reviewerSearchId" placeholder="Buscar por ID o Solicitante..." class="w-full px-3 py-2 border rounded-lg">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="date" id="reviewerDateFrom" class="w-full px-3 py-2 border rounded-lg text-sm" title="Fecha Desde">
                        <input type="date" id="reviewerDateTo" class="w-full px-3 py-2 border rounded-lg text-sm" title="Fecha Hasta">
                    </div>
                </div>
                <div class="max-h-[80vh] overflow-y-auto">
                    <div id="reviewerPendingRequests" class="grid gap-4 mb-6"></div>
                </div>
            </div>
        </div>
        
        <!-- VISTA GERENCIAL -->
        <div id="managerView" class="space-y-8" style="display: none;">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800 border-b pb-3">Panel de Informes Gerenciales</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
                    <div class="lg:col-span-2">
                        <label for="reportTimeRange" class="block text-sm font-medium text-gray-700">Rango de Tiempo</label>
                        <select id="reportTimeRange" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm">
                            <option value="today">Hoy</option>
                            <option value="this_week">Esta Semana</option>
                            <option value="this_month" selected>Este Mes</option>
                            <option value="last_3_months">Últimos 3 Meses</option>
                            <option value="all_time">Todo el Historial</option>
                            <option value="custom">Personalizado</option>
                        </select>
                    </div>
                    <div id="customDateRange" class="lg:col-span-2 grid grid-cols-2 gap-4 hidden">
                        <div>
                            <label for="reportDateFrom" class="block text-sm font-medium text-gray-700">Desde</label>
                            <input type="date" id="reportDateFrom" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm">
                        </div>
                        <div>
                            <label for="reportDateTo" class="block text-sm font-medium text-gray-700">Hasta</label>
                            <input type="date" id="reportDateTo" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm">
                        </div>
                    </div>
                    <div class="lg:col-span-1">
                        <button id="generateReportBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg">Generar Informe</button>
                    </div>
                </div>
            </div>
            
            <div id="reportContainer" style="display: none;">
                <div id="reportContent" class="bg-white p-8 space-y-8 rounded-xl shadow-lg">
                    <div class="text-center">
                        <h2 class="text-3xl font-bold text-gray-800">Informe Gerencial de Traslados</h2>
                        <p id="reportDateSubtitle" class="text-gray-500 mt-1"></p>
                    </div>
                    <hr/>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div><h3 class="text-gray-500">Total Solicitudes</h3><p id="kpiTotalRequests" class="text-2xl font-bold text-gray-900">-</p></div>
                        <div><h3 class="text-gray-500">Completadas</h3><p id="kpiCompleted" class="text-2xl font-bold text-green-600">-</p></div>
                        <div><h3 class="text-gray-500">Con Novedad</h3><p id="kpiWithNovelty" class="text-2xl font-bold text-yellow-600">-</p></div>
                        <div><h3 class="text-gray-500">Canceladas</h3><p id="kpiCancelled" class="text-2xl font-bold text-red-600">-</p></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 pt-8">
                        <div class="col-span-2 lg:col-span-1"><h3 class="text-xl font-semibold text-gray-800 mb-2 text-center">Estado de Solicitudes</h3><canvas id="statusChart"></canvas></div>
                        <div class="col-span-2 lg:col-span-1"><h3 class="text-xl font-semibold text-gray-800 mb-2 text-center">Top 5 Productos Más Solicitados</h3><canvas id="topProductsChart"></canvas></div>
                        <div class="col-span-2 lg:col-span-1"><h3 class="text-xl font-semibold text-gray-800 mb-2 text-center">Volumen por Bodega Destino</h3><canvas id="warehouseChart"></canvas></div>
                        <div class="col-span-2 lg:col-span-1"><h3 class="text-xl font-semibold text-gray-800 mb-2 text-center">Tasa de Cumplimiento (Unidades Recibidas)</h3><canvas id="fulfillmentChart"></canvas></div>
                        <div class="col-span-2 lg:col-span-1"><h3 class="text-xl font-semibold text-gray-800 mb-2 text-center">Unidades Solicitadas vs. Enviadas</h3><canvas id="requestedVsSentChart"></canvas></div>
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-4">
                    <button id="exportManagerReportBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg flex items-center space-x-2"><span>Exportar a Excel</span></button>
                    <button id="downloadPdfBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg flex items-center space-x-2"><span>Descargar como PDF</span></button>
                </div>
            </div>
        </div>
    </div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIGURACIÓN DE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCS-MiXwA9JcuoXdw2vhYWr-UWwyubFlbI",
            authDomain: "estado-de-pruebas001.firebaseapp.com",
            projectId: "estado-de-pruebas001",
            storageBucket: "estado-de-pruebas001.appspot.com",
            messagingSenderId: "17757056222",
            appId: "1:17757056222:web:a73b7b7832746a8291e64f",
            measurementId: "G-PGJVXH1BNM"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const transfersCollection = db.collection("transferencias");
        const productsCollection = db.collection("products");

        // --- ROLES DE USUARIO ---
        const USER_ROLES = {
            'administrador.pruebas@gmail.com': ['Administrador', 'admin'],
            'pruebaspb@gmail.com': ['Punto de venta Cali centro', 'requester'],
            'separador.pruebas@gmail.com': ['Usuario Revisor', 'reviewer'],
            'gerencia.pruebas@gmail.com': ['Gerencia', 'manager'],
        };

        // --- ESTADO GLOBAL DE LA APLICACIÓN ---
        let allProducts = [], currentTransferItems = [], allTransferRequests = [], currentUserData = null;
        let charts = {};
        let lastFilteredRequests = [];
        const expandedRequestsState = new Set();
        const sectionDisplayCounts = {};
        const INITIAL_DISPLAY_COUNT = 2;
        const LOAD_MORE_COUNT = 10;
        currentTransferItems = JSON.parse(localStorage.getItem('currentTransferDraft')) || [];

        // --- REFERENCIAS AL DOM ---
        const dom = {
            // ... (todas las referencias existentes)
            productList: document.getElementById('productList'),
            currentTransferRequest: document.getElementById('currentTransferRequest'),
            transferForm: document.getElementById('transferForm'),
            toWarehouse: document.getElementById('toWarehouse'),
            fromWarehouse: document.getElementById('fromWarehouse'),
            requesterName: document.getElementById('requesterName'),
            searchInput: document.getElementById('searchInput'),
            requesterView: document.getElementById('requesterView'),
            adminView: document.getElementById('adminView'),
            myShippedRequests: document.getElementById('myShippedRequests'),
            myPendingRequests: document.getElementById('myPendingRequests'),
            myNoveltyRequests: document.getElementById('myNoveltyRequests'),
            myCompletedRequests: document.getElementById('myCompletedRequests'),
            myCancelledRequests: document.getElementById('myCancelledRequests'),
            adminPendingRequests: document.getElementById('adminPendingRequests'),
            adminPendingNtRequests: document.getElementById('adminPendingNtRequests'),
            adminReadyToShipRequests: document.getElementById('adminReadyToShipRequests'),
            adminShippingDetailsRequests: document.getElementById('adminShippingDetailsRequests'),
            adminShippedRequests: document.getElementById('adminShippedRequests'),
            adminCompletedRequests: document.getElementById('adminCompletedRequests'),
            adminNoveltyRequests: document.getElementById('adminNoveltyRequests'),
            adminCancelledRequests: document.getElementById('adminCancelledRequests'),
            requesterSearchId: document.getElementById('requesterSearchId'),
            requesterDateFrom: document.getElementById('requesterDateFrom'),
            requesterDateTo: document.getElementById('requesterDateTo'),
            adminActiveSearchId: document.getElementById('adminActiveSearchId'),
            adminActiveDateFrom: document.getElementById('adminActiveDateFrom'),
            adminActiveDateTo: document.getElementById('adminActiveDateTo'),
            adminHistorySearchId: document.getElementById('adminHistorySearchId'),
            adminHistoryDateFrom: document.getElementById('adminHistoryDateFrom'),
            adminHistoryDateTo: document.getElementById('adminHistoryDateTo'),
            exportExcelBtn: document.getElementById('exportExcelBtn'),
            productManagementCard: document.getElementById('productManagementCard'),
            productFile: document.getElementById('productFile'),
            uploadProductsBtn: document.getElementById('uploadProductsBtn'),
            uploadStatus: document.getElementById('uploadStatus'),
            fileNameDisplay: document.getElementById('fileNameDisplay'),
            userEmailDisplay: document.getElementById('userEmailDisplay'),
            logoutBtn: document.getElementById('logoutBtn'),
            userInfo: document.getElementById('userInfo'),
            reviewerView: document.getElementById('reviewerView'),
            reviewerPendingRequests: document.getElementById('reviewerPendingRequests'),
            reviewerSearchId: document.getElementById('reviewerSearchId'),
            reviewerDateFrom: document.getElementById('reviewerDateFrom'),
            reviewerDateTo: document.getElementById('reviewerDateTo'),
            managerView: document.getElementById('managerView'),
            reportTimeRange: document.getElementById('reportTimeRange'),
            customDateRange: document.getElementById('customDateRange'),
            reportDateFrom: document.getElementById('reportDateFrom'),
            reportDateTo: document.getElementById('reportDateTo'),
            generateReportBtn: document.getElementById('generateReportBtn'),
            reportContainer: document.getElementById('reportContainer'),
            reportContent: document.getElementById('reportContent'),
            reportDateSubtitle: document.getElementById('reportDateSubtitle'),
            kpiTotalRequests: document.getElementById('kpiTotalRequests'),
            kpiCompleted: document.getElementById('kpiCompleted'),
            kpiWithNovelty: document.getElementById('kpiWithNovelty'),
            kpiCancelled: document.getElementById('kpiCancelled'),
            statusChart: document.getElementById('statusChart'),
            topProductsChart: document.getElementById('topProductsChart'),
            warehouseChart: document.getElementById('warehouseChart'),
            fulfillmentChart: document.getElementById('fulfillmentChart'),
            requestedVsSentChart: document.getElementById('requestedVsSentChart'),
            exportManagerReportBtn: document.getElementById('exportManagerReportBtn'),
            downloadPdfBtn: document.getElementById('downloadPdfBtn')
        };

        // --- FUNCIONES AUXILIARES ---
        const getRequestStatusColor = (s) => {
            if (s === 'pending' || s === 'processing_partial_items') return 'border-l-4 border-red-500 bg-red-50';
            if (['pending_nt_start', 'pending_nt_active', 'ready_to_ship', 'shipping_details', 'shipped', 'completed_incomplete', 'novelty_review'].includes(s)) return 'border-l-4 border-yellow-500 bg-yellow-50';
            if (s === 'completed') return 'border-l-4 border-green-500 bg-green-50';
            if (s === 'cancelled') return 'border-l-4 border-red-800 bg-red-100';
            return 'border-l-4 border-gray-300 bg-gray-50';
        };

        const translateStatus = (s, req) => {
            const statusMap = {
                'pending':'Pendiente', 'processing_partial_items':'En Revisión',
                'pending_nt_start': 'Pendiente por NT', 'pending_nt_active': 'Preparando NT',
                'ready_to_ship': 'Por Enviar', 'shipping_details': 'Pendiente de Guía',
                'shipped': 'Enviado (Por Recibir)', 'completed':'Recibido Completo', 
                'novelty_review': 'En Revisión de Novedad',
                'cancelled':'Cancelado'
            };
            if (s === 'completed_incomplete') return 'Recibido con Novedad';
            if (s === 'completed' && req?.novelty) return 'Recibido con Novedad (Resuelto)';
            return statusMap[s] || s;
        };
        
        // --- AUTENTICACIÓN Y ARRANQUE ---
        auth.onAuthStateChanged(user => {
            if (user) {
                const userDataFromMap = USER_ROLES[user.email];
                if (!userDataFromMap) { alert("Tu usuario no está autorizado."); auth.signOut(); return; }
                const [name, role] = userDataFromMap;
                currentUserData = { user, name, role };
                dom.userEmailDisplay.textContent = user.email;
                dom.userInfo.style.display = 'flex';
                initializeApp();
            } else { window.location.href = 'index.html'; }
        });

        dom.logoutBtn.onclick = () => auth.signOut();
        
        function setupUIForUser() {
            if (!currentUserData) return;
            const { name, role } = currentUserData;
            
            dom.requesterView.style.display = 'none';
            dom.adminView.style.display = 'none';
            dom.reviewerView.style.display = 'none';
            dom.managerView.style.display = 'none';
            if (dom.productManagementCard) dom.productManagementCard.style.display = 'none';
            if (dom.reportContainer) dom.reportContainer.style.display = 'none';

            if (role === 'admin') {
                dom.adminView.style.display = 'block';
                dom.managerView.style.display = 'block';
                if (dom.productManagementCard) dom.productManagementCard.style.display = 'block';
            } else if (role === 'reviewer') {
                dom.reviewerView.style.display = 'block';
            } else if (role === 'manager') {
                dom.managerView.style.display = 'block';
            } else { 
                dom.requesterView.style.display = 'grid';
                if (dom.requesterName) {
                    dom.requesterName.innerHTML = `<option value="${currentUserData.name}">${currentUserData.name}</option>`;
                    dom.requesterName.value = currentUserData.name;
                }
            }
        }
        
        // ... (el resto de las funciones de la aplicación, como renderAllSections, createRequestCard, etc., van aquí)
        
        // ==================================================================
        // INICIO DE LÓGICA PARA INFORMES GERENCIALES
        // ==================================================================
        function destroyCharts() {
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};
        }

        function handleReportGeneration() {
            const timeRange = dom.reportTimeRange.value;
            let endDate = new Date();
            endDate.setHours(23, 59, 59, 999);
            let startDate = new Date();
            startDate.setHours(0, 0, 0, 0);

            if (timeRange === 'all_time') {
                startDate = new Date(0);
            } else if (timeRange === 'today') {
                // Ya está configurado
            } else if (timeRange === 'this_week') {
                const day = startDate.getDay();
                const diff = startDate.getDate() - day + (day === 0 ? -6 : 1);
                startDate = new Date(startDate.setDate(diff));
                startDate.setHours(0, 0, 0, 0);
            } else if (timeRange === 'this_month') {
                startDate = new Date(endDate.getFullYear(), endDate.getMonth(), 1);
            } else if (timeRange === 'last_3_months') {
                startDate = new Date();
                startDate.setMonth(startDate.getMonth() - 3);
            } else if (timeRange === 'custom') {
                if (!dom.reportDateFrom.value || !dom.reportDateTo.value) {
                    alert("Por favor, selecciona un rango de fechas personalizado.");
                    return;
                }
                startDate = new Date(dom.reportDateFrom.value + 'T00:00:00');
                endDate = new Date(dom.reportDateTo.value + 'T23:59:59');
            }

            lastFilteredRequests = allTransferRequests.filter(req => {
                if (!req.timestamp?.toDate) return false;
                const reqDate = req.timestamp.toDate();
                return reqDate >= startDate && reqDate <= endDate;
            });

            if (lastFilteredRequests.length === 0) {
                alert("No se encontraron datos para el rango de fechas seleccionado.");
                if (dom.reportContainer) dom.reportContainer.style.display = 'none';
                return;
            }

            if (dom.reportContainer) dom.reportContainer.style.display = 'block';
            destroyCharts();
            generateAllReports(lastFilteredRequests);
        }

        function generateAllReports(data) {
            const today = new Date().toLocaleDateString('es-CO', { year: 'numeric', month: 'long', day: 'numeric' });
            dom.reportDateSubtitle.textContent = `Generado el: ${today}`;
            
            dom.kpiTotalRequests.textContent = data.length;
            dom.kpiCompleted.textContent = data.filter(r => r.status.startsWith('completed')).length;
            dom.kpiWithNovelty.textContent = data.filter(r => r.status === 'completed_incomplete' || r.status === 'novelty_review').length;
            dom.kpiCancelled.textContent = data.filter(r => r.status === 'cancelled').length;

            const chartOptions = { responsive: true, maintainAspectRatio: false, animation: false };

            const statusCounts = data.reduce((acc, req) => {
                const status = translateStatus(req.status, req);
                acc[status] = (acc[status] || 0) + 1;
                return acc;
            }, {});
            charts.statusChart = new Chart(dom.statusChart, {
                type: 'doughnut', data: { labels: Object.keys(statusCounts), datasets: [{ data: Object.values(statusCounts), backgroundColor: ['#22c55e', '#ef4444', '#f59e0b', '#3b82f6', '#6b7280', '#8b5cf6', '#f97316', '#06b6d4'] }] },
                options: chartOptions
            });

            const productCounts = data.reduce((acc, req) => {
                if(req.items) req.items.forEach(item => { acc[item.productName] = (acc[item.productName] || 0) + item.quantity; });
                return acc;
            }, {});
            const sortedProducts = Object.entries(productCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
            charts.topProductsChart = new Chart(dom.topProductsChart, {
                type: 'bar', data: { labels: sortedProducts.map(p => p[0]), datasets: [{ label: 'Unidades Solicitadas', data: sortedProducts.map(p => p[1]), backgroundColor: '#1f2937' }] },
                options: { ...chartOptions, indexAxis: 'y', plugins: { legend: { display: false } } }
            });

            const warehouseCounts = data.reduce((acc, req) => {
                if (req.toWarehouse) acc[req.toWarehouse] = (acc[req.toWarehouse] || 0) + 1;
                return acc;
            }, {});
            charts.warehouseChart = new Chart(dom.warehouseChart, {
                type: 'pie', data: { labels: Object.keys(warehouseCounts), datasets: [{ data: Object.values(warehouseCounts), backgroundColor: ['#1d4ed8', '#059669', '#d97706', '#dc2626', '#6d28d9', '#db2777'] }] },
                options: chartOptions
            });
            
            const fulfillmentData = data.filter(r => r.status.startsWith('completed')).reduce((acc, req) => {
                if(req.items) req.items.forEach(item => {
                    acc.sent += (item.sentQuantity || 0);
                    acc.received += (item.receivedQuantity || 0);
                });
                return acc;
            }, { sent: 0, received: 0 });
            charts.fulfillmentChart = new Chart(dom.fulfillmentChart, {
                type: 'bar', data: { labels: ['Cumplimiento'], datasets: [
                    { label: 'Unidades Enviadas', data: [fulfillmentData.sent], backgroundColor: '#a8a29e' },
                    { label: 'Unidades Recibidas', data: [fulfillmentData.received], backgroundColor: '#16a34a' }
                ]},
                options: chartOptions
            });

            // Lógica para el nuevo gráfico
            const requestedVsSentData = data.reduce((acc, req) => {
                if(req.items) req.items.forEach(item => {
                    acc.requested += (item.quantity || 0);
                    acc.sent += (item.sentQuantity || 0);
                });
                return acc;
            }, { requested: 0, sent: 0 });
            charts.requestedVsSentChart = new Chart(dom.requestedVsSentChart, {
                type: 'bar', data: { labels: ['Comparativo Global'], datasets: [
                    { label: 'Unidades Solicitadas', data: [requestedVsSentData.requested], backgroundColor: '#3b82f6' },
                    { label: 'Unidades Enviadas', data: [requestedVsSentData.sent], backgroundColor: '#f97316' }
                ]},
                options: chartOptions
            });
        }

        async function downloadPdfReport() {
            const reportElement = dom.reportContent;
            const today = new Date().toISOString().slice(0, 10);
            const opt = {
                margin: 0.5, filename: `Informe_Gerencial_${today}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            
            // Pausa para asegurar que los gráficos estén renderizados
            await new Promise(resolve => setTimeout(resolve, 500)); 

            html2pdf().from(reportElement).set(opt).save();
        }
        
        function exportManagerReport() {
            if (lastFilteredRequests.length === 0) {
                alert("Primero genera un resumen para poder exportar los datos.");
                return;
            }
            // ... (resto de la función de exportar a Excel)
        }

        async function initializeApp() {
            setupUIForUser();
            
            const listeners = [
                'requesterSearchId', 'requesterDateFrom', 'requesterDateTo', 
                'adminActiveSearchId', 'adminActiveDateFrom', 'adminActiveDateTo', 
                'adminHistorySearchId', 'adminHistoryDateFrom', 'adminHistoryDateTo', 
                'reviewerSearchId', 'reviewerDateFrom', 'reviewerDateTo'
            ];
            listeners.forEach(id => {
                if (dom[id]) dom[id].addEventListener('input', renderAllSections);
            });
            
            if (dom.reportTimeRange) {
                dom.reportTimeRange.addEventListener('change', () => {
                    dom.customDateRange.classList.toggle('hidden', dom.reportTimeRange.value !== 'custom');
                });
            }
            if (dom.generateReportBtn) dom.generateReportBtn.addEventListener('click', handleReportGeneration);
            if (dom.exportManagerReportBtn) dom.exportManagerReportBtn.addEventListener('click', exportManagerReport);
            if (dom.downloadPdfBtn) dom.downloadPdfBtn.addEventListener('click', downloadPdfReport);
            
            // ... (código restante de initializeApp, incluyendo el snapshot listener)
            
            transfersCollection.orderBy("timestamp", "desc").onSnapshot(snapshot => {
                allTransferRequests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAllSections();
                 if (currentUserData.role === 'manager' || currentUserData.role === 'admin') {
                    if (dom.reportContainer.style.display === 'block') {
                        handleReportGeneration();
                    }
                }
            }, error => console.error("Error al conectar: ", error));
        }
        
    }); // FIN DEL DOMContentLoaded
</script>
</body>
</html>
